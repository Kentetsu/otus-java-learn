<!DOCTYPE html>
<html lang="ru" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Пользователи</title>
    <style>
        table, th, td {
          border: 1px solid black;
        }
        table {
          border-collapse: collapse;
        }
        th, td {
          padding: 15px;
          text-align: left;
        }
    </style>
    <script>
        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function createClient() {
            const nameInput = document.getElementById('clientNameInput');
            const addressInput = document.getElementById('clientAddressInput');
            const phoneInput = document.getElementById('clientPhoneInput');

            const name = nameInput.value.trim();
            const address = addressInput.value.trim();
            const phone = phoneInput.value.trim();

            if (!name) {
                alert('Введите имя клиента');
                return;
            }

            const clientData = {
                name: name,
                address: address,
                phone: phone
            };

            fetch('/api/clients', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(clientData)
            })
            .then(response => {
                if (response.status === 201) {
                    return response.json();
                } else {
                    return response.json().then(error => {
                        throw new Error(error.error || 'Ошибка создания клиента');
                    });
                }
            })
            .then(createdClient => {
                nameInput.value = '';
                addressInput.value = '';
                phoneInput.value = '';
                document.getElementById('messageContainer').innerHTML =
                    '<span style="color: green;">Клиент "' + escapeHtml(createdClient.name) + '" успешно создан!</span>';
                // Перезагружаем страницу для обновления списка
                setTimeout(() => location.reload(), 1000);
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('messageContainer').innerHTML =
                    '<span style="color: red;">Ошибка: ' + escapeHtml(error.message) + '</span>';
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            const nameInput = document.getElementById('clientNameInput');
            nameInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    createClient();
                }
            });
        });
    </script>
</head>
<body>
<h2>Управление клиентами</h2>

<h4>Создание клиента</h4>
<div>
    <input type="text" id="clientNameInput" placeholder="Введите имя клиента">
    <input type="text" id="clientAddressInput" placeholder="Введите адрес">
    <input type="text" id="clientPhoneInput" placeholder="Введите телефон клиента">
    <button onclick="createClient()">Создать</button>
</div>
<div id="messageContainer" class="message"></div>

<h4>Список клиентов</h4>
<table>
    <thead>
    <tr>
        <th style="width: 50px">ID</th>
        <th style="width: 200px">Имя</th>
        <th style="width: 250px">Адрес</th>
        <th style="width: 150px">Телефон</th>
    </tr>
    </thead>
    <tbody id="clientsTableBody">
    <#if ListOfClient?? && ListOfClient?size gt 0>
    <#list ListOfClient as client>
    <tr>
        <td align="center">${client.id!''}</td>
        <td align="center">${client.name!''}</td>
        <td align="center">${(client.address.street)!'Не указан'}</td>
        <td align="center">
            <#if client.phones?? && client.phones?size gt 0>
            ${client.phones[0].number!''}
            <#if client.phones?size gt 1>
            (+${client.phones?size - 1})
        </#if>
        <#else>
        Не указан
    </#if>
    </td>
    </tr>
    </#list>
    <#else>
    <tr>
        <td colspan="4" style="text-align: center;">Нет клиентов</td>
    </tr>
</#if>
</tbody>
</table>
</body>
</html>